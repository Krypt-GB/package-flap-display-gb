#!/usr/bin/python

import time
import requests
from ics import Calendar
from ibquery import InfoBeamerQuery
from datetime import datetime

# URL of your Google Calendar ICS file
ICS_URL = "https://calendar.google.com/calendar/ical/55482e085e715a1d26cc4a40b330928113e9c7f252fa25d9c6b4138e735d94cd%40group.calendar.google.com/private-c15a39ea7a68d0ab6bde810dddd34645/basic.ics"

def get_todays_events():
    # Fetch the ICS file
    r = requests.get(ICS_URL)
    cal = Calendar(r.text)

    today = datetime.now().date()
    events_today = []

    for event in cal.events:
        # Compare the date of the event to today
        if event.begin.date() == today:
            events_today.append(event.name)

    # Join all events into a single line separated by commas
    return ", ".join(events_today) if events_today else "No events today"

def main():
    while True:
        ib = InfoBeamerQuery("127.0.0.1")

        # Get current date and time
        today_date = time.strftime("%A %d/%m/%Y %H:%M:%S")

        # Get today's Google Calendar events
        events_text = get_todays_events()

        # Connect to the display in atomic mode
        con = ib.node("display/atomic").io(raw=True)

        # Write to the display:
        # - Todays Menu
        # - blank line
        # - date & time
        # - today's calendar events
        con.write(f"Todays Menu\n \n{today_date}\n{events_text}\n")
        con.close()

        time.sleep(60)  # update every minute

if __name__ == "__main__":
    main()

