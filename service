#!/usr/bin/python

import time
import textwrap
import sys

try:
    import urllib2 as urllib
except ImportError:
    import urllib.request as urllib

from ibquery import InfoBeamerQuery

ICAL_URL = "https://calendar.google.com/calendar/ical/55482e085e715a1d26cc4a40b330928113e9c7f252fa25d9c6b4138e735d94cd%40group.calendar.google.com/public/basic.ics"

def get_todays_calendar_entries():
    try:
        print("Fetching calendar data...")
        response = urllib.urlopen(ICAL_URL)
        data = response.read().decode('utf-8')
        
        today_str = time.strftime("%Y%m%d")
        events = data.split("BEGIN:VEVENT")
        found_entries = []

        for event in events:
            # Check if this event starts today
            if ("DTSTART;VALUE=DATE:" + today_str in event) or ("DTSTART:" + today_str in event):
                summary = ""
                start_time = ""
                
                for line in event.splitlines():
                    if line.startswith("SUMMARY:"):
                        summary = line.replace("SUMMARY:", "").strip().upper()
                    if line.startswith("DTSTART"):
                        # Extract the time part for sorting (the part after the 'T')
                        # e.g., DTSTART:20231027T090000Z
                        if "T" in line:
                            start_time = line.split("T")[-1]
                        else:
                            # For all-day events, use a placeholder so they sort to the top
                            start_time = "000000"

                if summary:
                    # Store as a tuple (time, summary) so we can sort by time
                    found_entries.append((start_time, summary))
        
        # Sort the entries by the start_time (the first item in the tuple)
        found_entries.sort()
        
        # Return just the summaries in order
        return [entry[1] for entry in found_entries] if found_entries else ["NO ENTRIES PLANNED"]

    except Exception as e:
        print("Error fetching calendar: %s" % e)
        return ["CALENDAR ERROR"]

def main():
    WIDTH = 25 
    while 1:
        try:
            ib = InfoBeamerQuery("127.0.0.1")
            
            entries = get_todays_calendar_entries()
            today_date = time.strftime("%A %b %d")

            # Build the rows
            all_rows = ["", today_date, ""]
            
            for item in entries:
                wrapped_item = textwrap.wrap(item, width=WIDTH)
                for line in wrapped_item:
                    all_rows.append(line)
                # Small spacer between items
                all_rows.append("")

            # Open connection to 'atomic'
            con = ib.node("display/atomic").io(raw=True)
            
            # Write each row
            for row in all_rows:
                con.write(row + "\n")
            
            con.close()
            print("Successfully sent %d entries in order." % len(entries))

        except Exception as e:
            print("Main loop error: %s" % e)

        time.sleep(60)

if __name__ == "__main__":
    main()
