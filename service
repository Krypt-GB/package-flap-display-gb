#!/usr/bin/python

import time
import urllib2 # Use 'import urllib.request as urllib2' if on Python 3
from ibquery import InfoBeamerQuery

# PASTE YOUR ICAL LINK HERE
ICAL_URL = "https://calendar.google.com/calendar/ical/55482e085e715a1d26cc4a40b330928113e9c7f252fa25d9c6b4138e735d94cd%40group.calendar.google.com/public/basic.ics"

def get_todays_meal():
    try:
        # Fetch the calendar data
        response = urllib2.urlopen(ICAL_URL)
        data = response.read()
        
        # Today's date string as formatted in iCal (YYYYMMDD)
        today_str = time.strftime("%Y%m%d")
        
        # Basic parsing: split into events
        events = data.split("BEGIN:VEVENT")
        for event in events:
            # Check if this event starts today
            if "DTSTART;VALUE=DATE:" + today_str in event or "DTSTART:" + today_str in event:
                # Extract the SUMMARY (the meal name)
                for line in event.splitlines():
                    if line.startswith("SUMMARY:"):
                        return line.replace("SUMMARY:", "").strip()
        return "NO MEAL PLANNED"
    except Exception as e:
        return "CALENDAR ERROR"

def main():
    while 1:
        ib = InfoBeamerQuery("127.0.0.1")
        
        # Get data
        meal = get_todays_meal()
        today_date = time.strftime("%A %d-%m-%Y")

        # Connect to flap display in atomic mode
        # Line 1: Header
        # Line 2: Empty spacer
        # Line 3: Date
        # Line 4: The meal name (converted to uppercase for the flaps)
        con = ib.node("display/atomic").io(raw=True)
        con.write("\n TODAYS MENU\n \n%s\n\n%s\n " % (today_date, meal.upper()))
        con.close()

        # Update every hour to save bandwidth/API hits
        time.sleep(30)

if __name__ == "__main__":
    main()
